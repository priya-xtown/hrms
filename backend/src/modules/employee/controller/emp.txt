// // // src/modules/employee/controller/employee.controller.js
// // import Employee from "../models/employee.model.js";
// // import BaseService from "../../../services/service.js";
// // import path from "path";
// // const employeeService = new BaseService(Employee);
// // import PersonnelEmployee from "../../attandance/models/personalempolye.models.js";
// // import { Op } from "sequelize";

// // import EmployeeDetails from "../models/employeeDetails.model.js";
// // import EmployeeDocuments from "../models/employeeDocument.model.js";
// // import EmployeeEmergency from "../models/employeeEmergency.model.js";
// // import { sequelize } from "../../../db/index.js";

// // // ============================================================
// // // ðŸ”¹ Add Employee Extra Data (details + documents + emergency)
// // // ============================================================
// // export const createEmployee = async (req, res) => {
// //   try {
// //     // 1ï¸âƒ£ Extract fields safely
// //     const { first_name, last_name, ...otherFields } = req.body;

// //     const payload = {
// //       first_name,
// //       last_name,
// //       ...otherFields,
// //       // profile_picture: req.file
// //       //   ? `/uploads/employees/${req.file.filename}`
// //       //   : null,
// //       profile_picture: req.file ? req.file.filename : null,

// //       created_by: req.user?.id || "system",
// //     };

// //     let attendance_id;

// //     // 2ï¸âƒ£ Check if employee exists in xtown.personnel_employee
// //     try {
// //       const personnel = await PersonnelEmployee.findOne({
// //         where: { first_name: first_name, last_name: last_name },
// //       });

// //       if (personnel) {
// //         attendance_id = personnel.id; // âœ… Found existing record
// //         console.log("âœ… Existing personnel found:", attendance_id);
// //       } else {
// //         // ðŸ†• Create new record in xtown.personnel_employee
// //         const newPersonnel = await PersonnelEmployee.create({
// //           first_name: first_name,
// //           last_name: last_name,
// //           emp_code: otherFields.emp_id || null,
// //           status: 1,
// //           create_time: new Date(),
// //         });

// //         attendance_id = newPersonnel.id;
// //         console.log("ðŸ†• New personnel created:", attendance_id);
// //       }
// //     } catch (err) {
// //       console.error("âŒ xtown lookup failed, using fallback ID:", err);
// //       attendance_id = Date.now();
// //     }

// //     // 3ï¸âƒ£ Attach attendance_id to payload
// //     payload.attendance_id = attendance_id;

// //     // 4ï¸âƒ£ Create the employee in hrms_demo
// //     const newEmployee = await employeeService.create(payload);

// //     return res.status(201).json({
// //       message: "Employee added successfully",
// //       data: newEmployee,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in createEmployee:", error);
// //     return res.status(500).json({
// //       message: "Failed to create employee",
// //       error: error.message,
// //     });
// //   }
// // };

// // // PUT /api/employee/:id
// // export const updateEmployee = async (req, res) => {
// //   try {
// //     const { id } = req.params;
// //     const payload = {
// //       ...req.body,
// //       updated_by: req.user?.id || "system",
// //     };

// //      if (req.file) {
// //       payload.profile_picture = req.file.filename; // âœ… only filename
// //     }

// //     const updatedEmployee = await employeeService.update(id, payload);
// //     return res.status(200).json({
// //       message: "Employee updated successfully",
// //       data: updatedEmployee,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in updateEmployee:", error);
// //     return res.status(500).json({
// //       message: "Failed to update employee",
// //       error: error.message,
// //     });
// //   }
// // };


// // // GET /api/employee/all
// // export const getAllEmployees = async (req, res) => {
// //   try {
// //     const options = {
// //       includeInactive: req.query.includeInactive === "true" || false,
// //       search: req.query.search || "",
// //       page: req.query.page || 1,
// //       limit: req.query.limit || 10,
// //       orderBy: req.query.orderBy || "createdAt",
// //       order: req.query.order || "ASC",
// //       searchFields: ["first_name", "last_name", "emp_id", "attendance_id"],
// //     };

// //     const result = await employeeService.getAll(options);
// //     return res.status(200).json({
// //       message: "Employees fetched successfully",
// //       ...result,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in getAllEmployees:", error);
// //     return res.status(500).json({
// //       message: "Failed to fetch employees",
// //       error: error.message,
// //     });
// //   }
// // };

// // // GET /api/employee/:id
// // // export const getEmployeeById = async (req, res) => {
// // //   try {
// // //     const { id } = req.params;
// // //     const employee = await employeeService.getById(id);
// // //     return res.status(200).json({
// // //       message: "Employee fetched successfully",
// // //       data: employee,
// // //     });
// // //   } catch (error) {
// // //     console.error("âŒ Error in getEmployeeById:", error);
// // //     return res.status(500).json({
// // //       message: "Failed to fetch employee",
// // //       error: error.message,
// // //     });
// // //   }
// // // };


// // export const getEmployeeById = async (req, res) => {
// //   try {
// //     const { id } = req.params;

// //     const employee = await Employee.findOne({
// //       where: { id },
// //       include: [
// //         {
// //           model: EmployeeDetails,
// //           as: "details",
// //           include: [
// //             { model: Branch, as: "branches", attributes: ["id", "branch_name", "city", "state"] },
// //             { model: Department, as: "departments", attributes: ["id", "department_name"] },
// //             { model: Role, as: "designation", attributes: ["role_id", "role_name"] },
// //           ],
// //         },
// //         {
// //           model: EmployeeDocuments,
// //           as: "documents",
// //           attributes: {
// //             exclude: ["created_by", "updated_by", "deletedAt"],
// //           },
// //         },
// //         {
// //           model: EmployeeEmergency,
// //           as: "emergencies",
// //           attributes: {
// //             exclude: ["created_by", "updated_by", "deletedAt"],
// //           },
// //         },
// //       ],
// //     });

// //     if (!employee) {
// //       return res.status(404).json({ message: "Employee not found" });
// //     }

// //     return res.status(200).json({
// //       message: "Employee fetched successfully",
// //       data: employee,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in getEmployeeById:", error);
// //     return res.status(500).json({
// //       message: "Failed to fetch employee",
// //       error: error.message,
// //     });
// //   }
// // };


// // // DELETE /api/employee/:id
// // export const deleteEmployee = async (req, res) => {
// //   try {
// //     const { id } = req.params;
// //     const result = await employeeService.delete(id);
// //     return res.status(200).json({
// //       message: "Employee deleted successfully",
// //       data: result,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in deleteEmployee:", error);
// //     return res.status(500).json({
// //       message: "Failed to delete employee",
// //       error: error.message,
// //     });
// //   }
// // };


// // // // src/modules/employee/controller/employee.controller.js
// // // export const restoreEmployee = async (req, res) => {
// // //   try {
// // //     const { id } = req.params;
// // //     const employee = await Employee.findOne({
// // //       where: { id },
// // //       paranoid: false, // include soft-deleted records
// // //     });

// // //     if (!employee) {
// // //       return res.status(404).json({ message: "Employee not found" });
// // //     }

// // //     await employee.restore(); // restore the record
// // //     await employee.update({ is_active: true });

// // //     return res.status(200).json({
// // //       message: "Employee restored successfully",
// // //       data: employee,
// // //     });
// // //   } catch (error) {
// // //     console.error("âŒ Error in restoreEmployee:", error);
// // //     return res.status(500).json({
// // //       message: "Failed to restore employee",
// // //       error: error.message,
// // //     });
// // //   }
// // // };


// // export const addEmployeeFullInfo = async (req, res) => {
// //   const transaction = await sequelize.transaction();

// //   try {
// //     const { emp_id } = req.body;
// //     if (!emp_id) {
// //       return res.status(400).json({ message: "emp_id is required" });
// //     }

// //     // ---------------------------------------------------------
// //     // ðŸ”¹ 1. Employee Details
// //     // ---------------------------------------------------------
// //     const detailsData = JSON.parse(req.body.details || "{}");
// //     const employeeDetails = await EmployeeDetails.create(
// //       { ...detailsData, emp_id },
// //       { transaction }
// //     );

// //     // ---------------------------------------------------------
// //     // ðŸ”¹ 2. Employee Documents
// //     // ---------------------------------------------------------
// //     const docFields = [
// //       "resume",
// //       "aadhar",
// //       "pan",
// //       "degree",
// //       "marksheet",
// //       "relieving",
// //       "experience",
// //       "offer",
// //       "passport",
// //       "driving",
// //       "addressproof",
// //       "bankproof",
// //     ];

// //     const uploadedDocs = {};
// //     docFields.forEach((field) => {
// //       // if (req.files && req.files[field]) {
// //       //   uploadedDocs[field] = req.files[field][0].path;
// //       // }
// //       if (req.files && req.files[field]) {
// //         // ðŸ‘‡ Extract only filename (no folder path)
// //         uploadedDocs[field] = path.basename(req.files[field][0].path);
// //       }
// //     });

// //     const employeeDocuments = await EmployeeDocuments.create(
// //       { emp_id, ...uploadedDocs },
// //       { transaction }
// //     );

// //     // ---------------------------------------------------------
// //     // ðŸ”¹ 3. Employee Emergency Contacts (Array)
// //     // ---------------------------------------------------------
// //     const emergencyData = JSON.parse(req.body.emergency || "[]");

// //     const employeeEmergencies = await Promise.all(
// //       emergencyData.map((contact) =>
// //         EmployeeEmergency.create({ ...contact, emp_id }, { transaction })
// //       )
// //     );

// //     // ---------------------------------------------------------
// //     // ðŸ”¹ Commit Transaction
// //     // ---------------------------------------------------------
// //     await transaction.commit();

// //     return res.status(201).json({
// //       message: "Employee full info added successfully",
// //       data: {
// //         details: employeeDetails,
// //         documents: employeeDocuments,
// //         emergencies: employeeEmergencies,
// //       },
// //     });
// //   } catch (error) {
// //     await transaction.rollback();
// //     console.error("Error adding employee info:", error);
// //     return res.status(500).json({
// //       message: "Error adding employee information",
// //       error: error.message,
// //     });
// //   }
// // };

// // export default {
// //   createEmployee,
// //   getAllEmployees,
// //   getEmployeeById,
// //   updateEmployee,
// //   deleteEmployee,
// //   addEmployeeFullInfo
// // };


// // src/modules/employee/controller/employee.controller.js
// import path from "path";
// import { Op } from "sequelize";
// import { sequelize } from "../../../db/index.js";

// import Employee from "../models/employee.model.js";
// import EmployeeDetails from "../models/employeeDetails.model.js";
// import EmployeeDocuments from "../models/employeeDocument.model.js";
// import EmployeeEmergency from "../models/employeeEmergency.model.js";

// import Branch from "../models/branch.model.js";
// import Department from "../models/department.model.js";
// import Role from "../models/role.model.js";

// import PersonnelEmployee from "../../attandance/models/personalempolye.models.js";
// import BaseService from "../../../services/service.js";

// const employeeService = new BaseService(Employee);

// // ============================================================
// // ðŸ”¹ Add Employee
// // ============================================================
// export const createEmployee = async (req, res) => {
//   try {
//     const { first_name, last_name, emp_id, ...otherFields } = req.body;

//     if (!first_name || !last_name) {
//       return res.status(400).json({ message: "First name and last name are required" });
//     }

//     const payload = {
//       first_name,
//       last_name,
//       ...otherFields,
//       profile_picture: req.file ? `/uploads/employees/${req.file.filename}` : null,
//       created_by: req.user?.id || "system",
//     };

//     let attendance_id;

//     try {
//       // Prefer emp_id if exists
//       const personnelWhere = emp_id ? { emp_code: emp_id } : { first_name, last_name };
//       const personnel = await PersonnelEmployee.findOne({ where: personnelWhere });

//       if (personnel) {
//         attendance_id = personnel.id;
//       } else {
//         const newPersonnel = await PersonnelEmployee.create({
//           first_name,
//           last_name,
//           emp_code: emp_id || null,
//           status: 1,
//           create_time: new Date(),
//         });
//         attendance_id = newPersonnel.id;
//       }
//     } catch (err) {
//       attendance_id = Date.now(); // fallback
//     }

//     payload.attendance_id = attendance_id;

//     const newEmployee = await employeeService.create(payload);

//     return res.status(201).json({
//       message: "Employee added successfully",
//       data: newEmployee,
//     });
//   } catch (error) {
//     console.error("âŒ Error in createEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to create employee",
//       error: error.message,
//     });
//   }
// };

// // ============================================================
// // ðŸ”¹ Update Employee
// // ============================================================
// export const updateEmployee = async (req, res) => {
//   try {
//     const { id } = req.params;
//     const payload = {
//       ...req.body,
//       updated_by: req.user?.id || "system",
//     };

//     if (req.file) {
//       payload.profile_picture = `/uploads/employees/${req.file.filename}`;
//     }

//     const updatedEmployee = await employeeService.update(id, payload);

//     return res.status(200).json({
//       message: "Employee updated successfully",
//       data: updatedEmployee,
//     });
//   } catch (error) {
//     console.error("âŒ Error in updateEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to update employee",
//       error: error.message,
//     });
//   }
// };

// // ============================================================
// // ðŸ”¹ Get All Employees
// // ============================================================
// export const getAllEmployees = async (req, res) => {
//   try {
//     const options = {
//       includeInactive: req.query.includeInactive === "true",
//       search: req.query.search || "",
//       page: parseInt(req.query.page) || 1,
//       limit: parseInt(req.query.limit) || 10,
//       orderBy: req.query.orderBy || "createdAt",
//       order: req.query.order || "ASC",
//       searchFields: ["first_name", "last_name", "emp_id", "attendance_id"],
//     };

//     const result = await employeeService.getAll(options);

//     return res.status(200).json({
//       message: "Employees fetched successfully",
//       ...result,
//     });
//   } catch (error) {
//     console.error("âŒ Error in getAllEmployees:", error);
//     return res.status(500).json({
//       message: "Failed to fetch employees",
//       error: error.message,
//     });
//   }
// };

// // ============================================================
// // ðŸ”¹ Get Employee by ID
// // ============================================================
// // GET /api/employee/:id
// export const getEmployeeById = async (req, res) => {
//   try {
//     const { id } = req.params;

//     const employee = await Employee.findOne({
//       where: { id },
//       include: [
//         {
//           model: EmployeeDetails,
//           as: "details", // must match Employee -> EmployeeDetails association
//           include: [
//             {
//               model: Branch,
//               as: "branch", // use the alias defined in EmployeeDetails model
//               attributes: ["id", "branch_name", "city", "state"],
//             },
//             {
//               model: Department,
//               as: "department", // alias must match
//               attributes: ["id", "department_name"],
//             },
//             {
//               model: Role,
//               as: "designation", // alias must match
//               attributes: ["role_id", "role_name"],
//             },
//           ],
//         },
//         {
//           model: EmployeeDocuments,
//           as: "documents",
//           attributes: { exclude: ["created_by", "updated_by", "deletedAt"] },
//         },
//         {
//           model: EmployeeEmergency,
//           as: "emergencies",
//           attributes: { exclude: ["created_by", "updated_by", "deletedAt"] },
//         },
//       ],
//     });

//     if (!employee) {
//       return res.status(404).json({ message: "Employee not found" });
//     }

//     return res.status(200).json({
//       message: "Employee fetched successfully",
//       data: employee,
//     });
//   } catch (error) {
//     console.error("âŒ Error in getEmployeeById:", error);
//     return res.status(500).json({
//       message: "Failed to fetch employee",
//       error: error.message,
//     });
//   }
// };


// // ============================================================
// // ðŸ”¹ Delete Employee
// // ============================================================
// export const deleteEmployee = async (req, res) => {
//   try {
//     const { id } = req.params;
//     const result = await employeeService.delete(id);

//     return res.status(200).json({
//       message: "Employee deleted successfully",
//       data: result,
//     });
//   } catch (error) {
//     console.error("âŒ Error in deleteEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to delete employee",
//       error: error.message,
//     });
//   }
// };

// // ============================================================
// // ðŸ”¹ Add Full Employee Info (details + documents + emergency)
// // ============================================================
// export const addEmployeeFullInfo = async (req, res) => {
//   const transaction = await sequelize.transaction();

//   try {
//     const { emp_id } = req.body;
//     if (!emp_id) {
//       return res.status(400).json({ message: "emp_id is required" });
//     }

//     // Parse JSON fields safely
//     const detailsData = req.body.details ? JSON.parse(req.body.details) : {};
//     const emergencyData = req.body.emergency ? JSON.parse(req.body.emergency) : [];

//     // Employee Details
//     const employeeDetails = await EmployeeDetails.create(
//       { ...detailsData, emp_id },
//       { transaction }
//     );

//     // Employee Documents
//     const docFields = [
//       "resume","aadhar","pan","degree","marksheet","relieving","experience",
//       "offer","passport","driving","addressproof","bankproof"
//     ];

//     const uploadedDocs = {};
//     docFields.forEach((field) => {
//       if (req.files && req.files[field]) {
//         uploadedDocs[field] = path.basename(req.files[field][0].path);
//       }
//     });

//     const employeeDocuments = await EmployeeDocuments.create(
//       { emp_id, ...uploadedDocs },
//       { transaction }
//     );

//     // Employee Emergency Contacts
//     const employeeEmergencies = await Promise.all(
//       emergencyData.map((contact) => EmployeeEmergency.create({ ...contact, emp_id }, { transaction }))
//     );

//     await transaction.commit();

//     return res.status(201).json({
//       message: "Employee full info added successfully",
//       data: { details: employeeDetails, documents: employeeDocuments, emergencies: employeeEmergencies },
//     });
//   } catch (error) {
//     await transaction.rollback();
//     console.error("âŒ Error adding employee info:", error);
//     return res.status(500).json({
//       message: "Error adding employee information",
//       error: error.message,
//     });
//   }
// };

// export default {
//   createEmployee,
//   updateEmployee,
//   getAllEmployees,
//   getEmployeeById,
//   deleteEmployee,
//   addEmployeeFullInfo,
// };

// // // src/modules/employee/controller/employee.controller.js
// // import Employee from "../models/employee.model.js";
// // import BaseService from "../../../services/service.js";
// // import path from "path";
// // const employeeService = new BaseService(Employee);
// // import PersonnelEmployee from "../../attandance/models/personalempolye.models.js";
// // import { Op } from "sequelize";

// // import EmployeeDetails from "../models/employeeDetails.model.js";
// // import EmployeeDocuments from "../models/employeeDocument.model.js";
// // import EmployeeEmergency from "../models/employeeEmergency.model.js";
// // import { sequelize } from "../../../db/index.js";

// // // ============================================================
// // // ðŸ”¹ Add Employee Extra Data (details + documents + emergency)
// // // ============================================================
// // export const createEmployee = async (req, res) => {
// //   try {
// //     // 1ï¸âƒ£ Extract fields safely
// //     const { first_name, last_name, ...otherFields } = req.body;

// //     const payload = {
// //       first_name,
// //       last_name,
// //       ...otherFields,
// //       // profile_picture: req.file
// //       //   ? `/uploads/employees/${req.file.filename}`
// //       //   : null,
// //       profile_picture: req.file ? req.file.filename : null,

// //       created_by: req.user?.id || "system",
// //     };

// //     let attendance_id;

// //     // 2ï¸âƒ£ Check if employee exists in xtown.personnel_employee
// //     try {
// //       const personnel = await PersonnelEmployee.findOne({
// //         where: { first_name: first_name, last_name: last_name },
// //       });

// //       if (personnel) {
// //         attendance_id = personnel.id; // âœ… Found existing record
// //         console.log("âœ… Existing personnel found:", attendance_id);
// //       } else {
// //         // ðŸ†• Create new record in xtown.personnel_employee
// //         const newPersonnel = await PersonnelEmployee.create({
// //           first_name: first_name,
// //           last_name: last_name,
// //           emp_code: otherFields.emp_id || null,
// //           status: 1,
// //           create_time: new Date(),
// //         });

// //         attendance_id = newPersonnel.id;
// //         console.log("ðŸ†• New personnel created:", attendance_id);
// //       }
// //     } catch (err) {
// //       console.error("âŒ xtown lookup failed, using fallback ID:", err);
// //       attendance_id = Date.now();
// //     }

// //     // 3ï¸âƒ£ Attach attendance_id to payload
// //     payload.attendance_id = attendance_id;

// //     // 4ï¸âƒ£ Create the employee in hrms_demo
// //     const newEmployee = await employeeService.create(payload);

// //     return res.status(201).json({
// //       message: "Employee added successfully",
// //       data: newEmployee,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in createEmployee:", error);
// //     return res.status(500).json({
// //       message: "Failed to create employee",
// //       error: error.message,
// //     });
// //   }
// // };

// // // PUT /api/employee/:id
// // export const updateEmployee = async (req, res) => {
// //   try {
// //     const { id } = req.params;
// //     const payload = {
// //       ...req.body,
// //       updated_by: req.user?.id || "system",
// //     };

// //      if (req.file) {
// //       payload.profile_picture = req.file.filename; // âœ… only filename
// //     }

// //     const updatedEmployee = await employeeService.update(id, payload);
// //     return res.status(200).json({
// //       message: "Employee updated successfully",
// //       data: updatedEmployee,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in updateEmployee:", error);
// //     return res.status(500).json({
// //       message: "Failed to update employee",
// //       error: error.message,
// //     });
// //   }
// // };


// // // GET /api/employee/all
// // export const getAllEmployees = async (req, res) => {
// //   try {
// //     const options = {
// //       includeInactive: req.query.includeInactive === "true" || false,
// //       search: req.query.search || "",
// //       page: req.query.page || 1,
// //       limit: req.query.limit || 10,
// //       orderBy: req.query.orderBy || "createdAt",
// //       order: req.query.order || "ASC",
// //       searchFields: ["first_name", "last_name", "emp_id", "attendance_id"],
// //     };

// //     const result = await employeeService.getAll(options);
// //     return res.status(200).json({
// //       message: "Employees fetched successfully",
// //       ...result,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in getAllEmployees:", error);
// //     return res.status(500).json({
// //       message: "Failed to fetch employees",
// //       error: error.message,
// //     });
// //   }
// // };

// // // GET /api/employee/:id
// // // export const getEmployeeById = async (req, res) => {
// // //   try {
// // //     const { id } = req.params;
// // //     const employee = await employeeService.getById(id);
// // //     return res.status(200).json({
// // //       message: "Employee fetched successfully",
// // //       data: employee,
// // //     });
// // //   } catch (error) {
// // //     console.error("âŒ Error in getEmployeeById:", error);
// // //     return res.status(500).json({
// // //       message: "Failed to fetch employee",
// // //       error: error.message,
// // //     });
// // //   }
// // // };


// // export const getEmployeeById = async (req, res) => {
// //   try {
// //     const { id } = req.params;

// //     const employee = await Employee.findOne({
// //       where: { id },
// //       include: [
// //         {
// //           model: EmployeeDetails,
// //           as: "details",
// //           include: [
// //             { model: Branch, as: "branches", attributes: ["id", "branch_name", "city", "state"] },
// //             { model: Department, as: "departments", attributes: ["id", "department_name"] },
// //             { model: Role, as: "designation", attributes: ["role_id", "role_name"] },
// //           ],
// //         },
// //         {
// //           model: EmployeeDocuments,
// //           as: "documents",
// //           attributes: {
// //             exclude: ["created_by", "updated_by", "deletedAt"],
// //           },
// //         },
// //         {
// //           model: EmployeeEmergency,
// //           as: "emergencies",
// //           attributes: {
// //             exclude: ["created_by", "updated_by", "deletedAt"],
// //           },
// //         },
// //       ],
// //     });

// //     if (!employee) {
// //       return res.status(404).json({ message: "Employee not found" });
// //     }

// //     return res.status(200).json({
// //       message: "Employee fetched successfully",
// //       data: employee,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in getEmployeeById:", error);
// //     return res.status(500).json({
// //       message: "Failed to fetch employee",
// //       error: error.message,
// //     });
// //   }
// // };


// // // DELETE /api/employee/:id
// // export const deleteEmployee = async (req, res) => {
// //   try {
// //     const { id } = req.params;
// //     const result = await employeeService.delete(id);
// //     return res.status(200).json({
// //       message: "Employee deleted successfully",
// //       data: result,
// //     });
// //   } catch (error) {
// //     console.error("âŒ Error in deleteEmployee:", error);
// //     return res.status(500).json({
// //       message: "Failed to delete employee",
// //       error: error.message,
// //     });
// //   }
// // };


// // // // src/modules/employee/controller/employee.controller.js
// // // export const restoreEmployee = async (req, res) => {
// // //   try {
// // //     const { id } = req.params;
// // //     const employee = await Employee.findOne({
// // //       where: { id },
// // //       paranoid: false, // include soft-deleted records
// // //     });

// // //     if (!employee) {
// // //       return res.status(404).json({ message: "Employee not found" });
// // //     }

// // //     await employee.restore(); // restore the record
// // //     await employee.update({ is_active: true });

// // //     return res.status(200).json({
// // //       message: "Employee restored successfully",
// // //       data: employee,
// // //     });
// // //   } catch (error) {
// // //     console.error("âŒ Error in restoreEmployee:", error);
// // //     return res.status(500).json({
// // //       message: "Failed to restore employee",
// // //       error: error.message,
// // //     });
// // //   }
// // // };


// // export const addEmployeeFullInfo = async (req, res) => {
// //   const transaction = await sequelize.transaction();

// //   try {
// //     const { emp_id } = req.body;
// //     if (!emp_id) {
// //       return res.status(400).json({ message: "emp_id is required" });
// //     }

// //     // ---------------------------------------------------------
// //     // ðŸ”¹ 1. Employee Details
// //     // ---------------------------------------------------------
// //     const detailsData = JSON.parse(req.body.details || "{}");
// //     const employeeDetails = await EmployeeDetails.create(
// //       { ...detailsData, emp_id },
// //       { transaction }
// //     );

// //     // ---------------------------------------------------------
// //     // ðŸ”¹ 2. Employee Documents
// //     // ---------------------------------------------------------
// //     const docFields = [
// //       "resume",
// //       "aadhar",
// //       "pan",
// //       "degree",
// //       "marksheet",
// //       "relieving",
// //       "experience",
// //       "offer",
// //       "passport",
// //       "driving",
// //       "addressproof",
// //       "bankproof",
// //     ];

// //     const uploadedDocs = {};
// //     docFields.forEach((field) => {
// //       // if (req.files && req.files[field]) {
// //       //   uploadedDocs[field] = req.files[field][0].path;
// //       // }
// //       if (req.files && req.files[field]) {
// //         // ðŸ‘‡ Extract only filename (no folder path)
// //         uploadedDocs[field] = path.basename(req.files[field][0].path);
// //       }
// //     });

// //     const employeeDocuments = await EmployeeDocuments.create(
// //       { emp_id, ...uploadedDocs },
// //       { transaction }
// //     );

// //     // ---------------------------------------------------------
// //     // ðŸ”¹ 3. Employee Emergency Contacts (Array)
// //     // ---------------------------------------------------------
// //     const emergencyData = JSON.parse(req.body.emergency || "[]");

// //     const employeeEmergencies = await Promise.all(
// //       emergencyData.map((contact) =>
// //         EmployeeEmergency.create({ ...contact, emp_id }, { transaction })
// //       )
// //     );

// //     // ---------------------------------------------------------
// //     // ðŸ”¹ Commit Transaction
// //     // ---------------------------------------------------------
// //     await transaction.commit();

// //     return res.status(201).json({
// //       message: "Employee full info added successfully",
// //       data: {
// //         details: employeeDetails,
// //         documents: employeeDocuments,
// //         emergencies: employeeEmergencies,
// //       },
// //     });
// //   } catch (error) {
// //     await transaction.rollback();
// //     console.error("Error adding employee info:", error);
// //     return res.status(500).json({
// //       message: "Error adding employee information",
// //       error: error.message,
// //     });
// //   }
// // };

// // export default {
// //   createEmployee,
// //   getAllEmployees,
// //   getEmployeeById,
// //   updateEmployee,
// //   deleteEmployee,
// //   addEmployeeFullInfo
// // };


// // src/modules/employee/controller/employee.controller.js
// import path from "path";
// import { Op } from "sequelize";
// import { sequelize } from "../../../db/index.js";

// import Employee from "../models/employee.model.js";
// import EmployeeDetails from "../models/employeeDetails.model.js";
// import EmployeeDocuments from "../models/employeeDocument.model.js";
// import EmployeeEmergency from "../models/employeeEmergency.model.js";

// import Branch from "../models/branch.model.js";
// import Department from "../models/department.model.js";
// import Role from "../models/role.model.js";

// import PersonnelEmployee from "../../attandance/models/personalempolye.models.js";
// import BaseService from "../../../services/service.js";

// const employeeService = new BaseService(Employee);

// // ============================================================
// // ðŸ”¹ Add Employee
// // ============================================================
// export const createEmployee = async (req, res) => {
//   try {
//     const { first_name, last_name, emp_id, ...otherFields } = req.body;

//     if (!first_name || !last_name) {
//       return res.status(400).json({ message: "First name and last name are required" });
//     }

//     const payload = {
//       first_name,
//       last_name,
//       ...otherFields,
//       profile_picture: req.file ? `/uploads/employees/${req.file.filename}` : null,
//       created_by: req.user?.id || "system",
//     };

//     let attendance_id;

//     try {
//       // Prefer emp_id if exists
//       const personnelWhere = emp_id ? { emp_code: emp_id } : { first_name, last_name };
//       const personnel = await PersonnelEmployee.findOne({ where: personnelWhere });

//       if (personnel) {
//         attendance_id = personnel.id;
//       } else {
//         const newPersonnel = await PersonnelEmployee.create({
//           first_name,
//           last_name,
//           emp_code: emp_id || null,
//           status: 1,
//           create_time: new Date(),
//         });
//         attendance_id = newPersonnel.id;
//       }
//     } catch (err) {
//       attendance_id = Date.now(); // fallback
//     }

//     payload.attendance_id = attendance_id;

//     const newEmployee = await employeeService.create(payload);

//     return res.status(201).json({
//       message: "Employee added successfully",
//       data: newEmployee,
//     });
//   } catch (error) {
//     console.error("âŒ Error in createEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to create employee",
//       error: error.message,
//     });
//   }
// };

// // ============================================================
// // ðŸ”¹ Update Employee
// // ============================================================
// export const updateEmployee = async (req, res) => {
//   try {
//     const { id } = req.params;
//     const payload = {
//       ...req.body,
//       updated_by: req.user?.id || "system",
//     };

//     if (req.file) {
//       payload.profile_picture = `/uploads/employees/${req.file.filename}`;
//     }

//     const updatedEmployee = await employeeService.update(id, payload);

//     return res.status(200).json({
//       message: "Employee updated successfully",
//       data: updatedEmployee,
//     });
//   } catch (error) {
//     console.error("âŒ Error in updateEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to update employee",
//       error: error.message,
//     });
//   }
// };

// // ============================================================
// // ðŸ”¹ Get All Employees
// // ============================================================
// export const getAllEmployees = async (req, res) => {
//   try {
//     const options = {
//       includeInactive: req.query.includeInactive === "true",
//       search: req.query.search || "",
//       page: parseInt(req.query.page) || 1,
//       limit: parseInt(req.query.limit) || 10,
//       orderBy: req.query.orderBy || "createdAt",
//       order: req.query.order || "ASC",
//       searchFields: ["first_name", "last_name", "emp_id", "attendance_id"],
//     };

//     const result = await employeeService.getAll(options);

//     return res.status(200).json({
//       message: "Employees fetched successfully",
//       ...result,
//     });
//   } catch (error) {
//     console.error("âŒ Error in getAllEmployees:", error);
//     return res.status(500).json({
//       message: "Failed to fetch employees",
//       error: error.message,
//     });
//   }
// };

// // ============================================================
// // ðŸ”¹ Get Employee by ID
// // ============================================================
// // GET /api/employee/:id
// export const getEmployeeById = async (req, res) => {
//   try {
//     const { id } = req.params;

//     const employee = await Employee.findOne({
//       where: { id },
//       include: [
//         {
//           model: EmployeeDetails,
//           as: "details", // must match Employee -> EmployeeDetails association
//           include: [
//             {
//               model: Branch,
//               as: "branch", // use the alias defined in EmployeeDetails model
//               attributes: ["id", "branch_name", "city", "state"],
//             },
//             {
//               model: Department,
//               as: "department", // alias must match
//               attributes: ["id", "department_name"],
//             },
//             {
//               model: Role,
//               as: "designation", // alias must match
//               attributes: ["role_id", "role_name"],
//             },
//           ],
//         },
//         {
//           model: EmployeeDocuments,
//           as: "documents",
//           attributes: { exclude: ["created_by", "updated_by", "deletedAt"] },
//         },
//         {
//           model: EmployeeEmergency,
//           as: "emergencies",
//           attributes: { exclude: ["created_by", "updated_by", "deletedAt"] },
//         },
//       ],
//     });

//     if (!employee) {
//       return res.status(404).json({ message: "Employee not found" });
//     }

//     return res.status(200).json({
//       message: "Employee fetched successfully",
//       data: employee,
//     });
//   } catch (error) {
//     console.error("âŒ Error in getEmployeeById:", error);
//     return res.status(500).json({
//       message: "Failed to fetch employee",
//       error: error.message,
//     });
//   }
// };


// // ============================================================
// // ðŸ”¹ Delete Employee
// // ============================================================
// export const deleteEmployee = async (req, res) => {
//   try {
//     const { id } = req.params;
//     const result = await employeeService.delete(id);

//     return res.status(200).json({
//       message: "Employee deleted successfully",
//       data: result,
//     });
//   } catch (error) {
//     console.error("âŒ Error in deleteEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to delete employee",
//       error: error.message,
//     });
//   }
// };

// // ============================================================
// // ðŸ”¹ Add Full Employee Info (details + documents + emergency)
// // ============================================================
// export const addEmployeeFullInfo = async (req, res) => {
//   const transaction = await sequelize.transaction();

//   try {
//     const { emp_id } = req.body;
//     if (!emp_id) {
//       return res.status(400).json({ message: "emp_id is required" });
//     }

//     // Parse JSON fields safely
//     const detailsData = req.body.details ? JSON.parse(req.body.details) : {};
//     const emergencyData = req.body.emergency ? JSON.parse(req.body.emergency) : [];

//     // Employee Details
//     const employeeDetails = await EmployeeDetails.create(
//       { ...detailsData, emp_id },
//       { transaction }
//     );

//     // Employee Documents
//     const docFields = [
//       "resume","aadhar","pan","degree","marksheet","relieving","experience",
//       "offer","passport","driving","addressproof","bankproof"
//     ];

//     const uploadedDocs = {};
//     docFields.forEach((field) => {
//       if (req.files && req.files[field]) {
//         uploadedDocs[field] = path.basename(req.files[field][0].path);
//       }
//     });

//     const employeeDocuments = await EmployeeDocuments.create(
//       { emp_id, ...uploadedDocs },
//       { transaction }
//     );

//     // Employee Emergency Contacts
//     const employeeEmergencies = await Promise.all(
//       emergencyData.map((contact) => EmployeeEmergency.create({ ...contact, emp_id }, { transaction }))
//     );

//     await transaction.commit();

//     return res.status(201).json({
//       message: "Employee full info added successfully",
//       data: { details: employeeDetails, documents: employeeDocuments, emergencies: employeeEmergencies },
//     });
//   } catch (error) {
//     await transaction.rollback();
//     console.error("âŒ Error adding employee info:", error);
//     return res.status(500).json({
//       message: "Error adding employee information",
//       error: error.message,
//     });
//   }
// };

// export default {
//   createEmployee,
//   updateEmployee,
//   getAllEmployees,
//   getEmployeeById,
//   deleteEmployee,
//   addEmployeeFullInfo,
// };

// ============================================================
// ðŸ”¹ Add Full Employee Info (details + documents + emergency)
// ============================================================
// export const addEmployeeFullInfo = async (req, res) => {
//   const transaction = await sequelize.transaction();

//   try {
//     const { emp_id } = req.body;
//     if (!emp_id) {
//       return res.status(400).json({ message: "emp_id is required" });
//     }

//     const detailsData = req.body.details ? JSON.parse(req.body.details) : {};
//     const emergencyData = req.body.emergency ? JSON.parse(req.body.emergency) : [];

//     // Employee Details
//     const employeeDetails = await EmployeeDetails.create(
//       { ...detailsData, emp_id },
//       { transaction }
//     );

//     // Employee Documents
//     const docFields = [
//       "resume","aadhar","pan","degree","marksheet","relieving","experience",
//       "offer","passport","driving","addressproof","bankproof"
//     ];

//     const uploadedDocs = {};
//     docFields.forEach((field) => {
//       if (req.files && req.files[field]) {
//         uploadedDocs[field] = path.basename(req.files[field][0].path);
//       }
//     });

//     const employeeDocuments = await EmployeeDocuments.create(
//       { emp_id, ...uploadedDocs },
//       { transaction }
//     );

//     // Employee Emergency Contacts
//     const employeeEmergencies = await Promise.all(
//       emergencyData.map((contact) => EmployeeEmergency.create({ ...contact, emp_id }, { transaction }))
//     );

//     await transaction.commit();

//     return res.status(201).json({
//       message: "Employee full info added successfully",
//       data: { details: employeeDetails, documents: employeeDocuments, emergencies: employeeEmergencies },
//     });
//   } catch (error) {
//     await transaction.rollback();
//     console.error("âŒ Error adding employee info:", error);
//     return res.status(500).json({
//       message: "Error adding employee information",
//       error: error.message,
//     });
//   }
// };

    // // ðŸŸ¢ 3ï¸âƒ£ EmployeeEmergency Contacts (unchanged logic)
    // if (req.body.emergency) {
    //   const emergencyData = JSON.parse(req.body.emergency);

    //   await EmployeeEmergency.destroy({ where: { emp_id }, transaction });

    //   if (emergencyData.length > 0) {
    //     await Promise.all(
    //       emergencyData.map((contact) =>
    //         EmployeeEmergency.create(
    //           { ...contact, emp_id, created_by: userId, updated_by: userId },
    //           { transaction }
    //         )
    //       )
    //     );
    //   }
    // } else {
    //   console.log("â© Skipping emergency contact update since none was provided.");
    // }

// // src/modules/employee/models/employee.model.js
// import { DataTypes, Op } from "sequelize";
// import { sequelize } from "../../../db/index.js";

// const Employee = sequelize.define(
//   "Employee",
//   {
//     id: {
//       type: DataTypes.UUID,
//       // defaultValue: DataTypes.UUIDV4,
//       primaryKey: true,
//       allowNull: true,
//     },
//     emp_id: {
//       type: DataTypes.STRING,
//       type: DataTypes.UUID,
//       allowNull: false,
//       unique: true,
//     }, 
//     attendance_id: {
//       type: DataTypes.STRING,
//       allowNull: false,
//     },
//     first_name: {
//       type: DataTypes.STRING,
//       allowNull: false,
//     },
//     last_name: {
//       type: DataTypes.STRING,
//       allowNull: false,
//     },
//     date_of_joining: {
//       type: DataTypes.DATEONLY,
//       allowNull: false,
//     },
//     reporting_manager: {
//       type: DataTypes.STRING,
//       allowNull: false,
//     },
//     employee_type: {
//       type: DataTypes.ENUM("Permanent", "Contract", "Intern"),
//       allowNull: false,
//     },
//     status: {
//       type: DataTypes.ENUM("Active", "Inactive"),
//       defaultValue: "Active",
//     },
//     shift_type: {
//       type: DataTypes.STRING,
//       allowNull: false,
//     },
//     profile_picture: {
//       type: DataTypes.STRING,
//       allowNull: true,
//     },
//     created_by: {
//       type: DataTypes.UUID,
//       allowNull: false,
//       references: {
//         model: "endusers",
//         key: "id",
//       },
//     },
//     updated_by: {
//       type: DataTypes.UUID,
//       allowNull: true,
//       references: {
//         model: "endusers",
//         key: "id",
//       },
//     },
//   },
//   {
//     tableName: "employees",
//     timestamps: true,
//     paranoid: true, // enables soft delete
//     deletedAt: "deleted_at",

//     hooks: {
//       beforeCreate: async (employee) => {
//         if (!employee.emp_id) {
//           const year = new Date().getFullYear().toString().slice(-2); // e.g. "25"
//           const prefix = `XT-${year}-`;

//           const lastEmployee = await Employee.findOne({
//             where: { emp_id: { [Op.like]: `${prefix}%` } },
//             order: [["createdAt", "DESC"]],
//           });

//           let sequence = 1;
//           if (lastEmployee) {
//             const lastSeq = parseInt(lastEmployee.emp_id.split("-")[2], 10);
//             sequence = lastSeq + 1;
//           }

//           const paddedSeq = String(sequence).padStart(3, "0");
//           employee.emp_id = `${prefix}${paddedSeq}`;
//         }
//       },
//     },
//   }
// );

    // let attendance_id;

    // try {
    //   const personnelWhere = emp_id ? { emp_code: emp_id } : { first_name, last_name };
    //   const personnel = await PersonnelEmployee.findOne({ where: personnelWhere });

    //   if (personnel) {
    //     attendance_id = personnel.id;
    //   } else {
    //     const newPersonnel = await PersonnelEmployee.create({
    //       first_name,
    //       last_name,
    //       emp_code: emp_id || null,
    //       status: 1,
    //       create_time: new Date(),
    //     });
    //     attendance_id = newPersonnel.id;
    //   }
    // } catch (err) {
    //   attendance_id = Date.now(); // fallback
    // }

    // payload.attendance_id = attendance_id;

    export const createEmployee = async (req, res) => {
  try {
    const { first_name, last_name, emp_id,  ...otherFields } = req.body;

    if (!first_name || !last_name) {
      return res.status(400).json({ message: "First name and last name are required" });
    }

    const payload = {
      first_name,
      last_name,
      ...otherFields,
      profile_picture: req.file ? `/uploads/employees/${req.file.filename}` : null,
      created_by: req.user?.id || "system",
    };

    const newEmployee = await employeeService.create(payload);

    return res.status(201).json({
      message: "Employee added successfully",
      data: newEmployee,
    });
  } catch (error) {
    console.error("âŒ Error in createEmployee:", error);
    return res.status(500).json({
      message: "Failed to create employee",
      error: error.message,
    });
  }
}
=========================================================================================



// export const createEmployee = async (req, res) => {
//   try {
//     const { first_name, last_name, emp_id, ...otherFields } = req.body;

//     if (!first_name || !last_name) {
//       return res.status(400).json({ message: "First name and last name are required" });
//     }

//     const payload = {
//       first_name,
//       last_name,
//       emp_id,
//       ...otherFields,
//       profile_picture: req.file ? req.file.filename : null,
//       created_by: req.user?.id || "system",
//     };

//     const newEmployee = await employeeService.create(payload);

//     return res.status(201).json({
//       message: "Employee added successfully",
//       data: newEmployee,
//     });
//   } catch (error) {
//     console.error("âŒ Error in createEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to create employee",
//       error: error.message,
//     });
//   }
// };

// ============================================================
// ðŸ”¹ Update Employee
// ============================================================


// export const createEmployee = async (req, res) => {
//   try {
//     const { first_name, last_name, attendance_id, emp_id, ...otherFields } = req.body;

//     if (!first_name || !last_name) {
//       return res.status(400).json({ message: "First name and last name are required" });
//     }

//     // â­ map attendance_id to emp_code
//     const emp_code = attendance_id;

//     if (!emp_code) {
//       return res.status(400).json({
//         message: "Attendance ID is required",
//       });
//     }

//     // ============================================================
//     // 1ï¸âƒ£ CHECK â€” emp_code already exists in ATT DB?
//     // ============================================================
//     const attRecord = await PersonnelEmployee.findOne({
//       where: { emp_code },
//     });

//     if (attRecord) {
//       return res.status(400).json({
//         message: "Attendance ID already exists in ATT database",
//         emp_code,
//       });
//     }

//     // ============================================================
//     // 2ï¸âƒ£ CHECK â€” emp_code already exists in HRMS DB?
//     // ============================================================
//     const hrmsRecord = await Employee.findOne({
//       where: { attendance_id: emp_code },
//     });

//     if (hrmsRecord) {
//       return res.status(400).json({
//         message: "Attendance ID already exists in HRMS database",
//         emp_code,
//       });
//     }

//     // ============================================================
//     // 3ï¸âƒ£ If safe â†’ create employee
//     // ============================================================
//     const payload = {
//       first_name,
//       last_name,
//       emp_id,
//       attendance_id: emp_code,
//       ...otherFields,
//       profile_picture: req.file ? req.file.filename : null,
//       created_by: req.user?.id || "system",
//     };

//     const newEmployee = await employeeService.create(payload);

//     return res.status(201).json({
//       message: "Employee added successfully",
//       data: newEmployee,
//     });

//   } catch (error) {
//     console.error("âŒ Error in createEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to create employee",
//       error: error.message,
//     });
//   }
// };


// export const createEmployee = async (req, res) => {
//   try {
//     const { first_name, last_name, attendance_id, emp_id, ...otherFields } = req.body;

//     if (!first_name || !last_name) {
//       return res.status(400).json({
//         message: "First name and last name are required",
//       });
//     }

//     // â­ Treat attendance_id as emp_code
//     const emp_code = attendance_id;

//     if (!emp_code) {
//       return res.status(400).json({
//         message: "Attendance ID is required",
//       });
//     }

//     // Normalize names for comparison
//     const inputFirst = first_name.trim().toLowerCase();
//     const inputLast = last_name.trim().toLowerCase();

//     // ============================================================
//     // 1ï¸âƒ£ ATT DB â€” Check by emp_code
//     // ============================================================
//     const attByCode = await PersonnelEmployee.findOne({
//       where: { emp_code },
//     });

//     // ============================================================
//     // 2ï¸âƒ£ ATT DB â€” Check by NAME
//     // ============================================================
//     const attByName = await PersonnelEmployee.findOne({
//       where: {
//         first_name: first_name,
//         last_name: last_name,
//       },
//     });

//     // ============================================================
//     // CASE A â€” emp_code DOES NOT exist in ATT DB
//     // ============================================================
//     if (!attByCode) {
//       // If same name exists in ATT DB but emp_code is different â†’ BLOCK
//       if (attByName) {
//         return res.status(400).json({
//           message: "Employee name already exists in ATT database with a different Attendance ID.",
//           existing_emp_code: attByName.emp_code,
//         });
//       }
//       // âœ” Code not found + name not found â†’ ALLOW
//     }

//     // ============================================================
//     // CASE B â€” emp_code EXISTS â†’ validate NAME
//     // ============================================================
//     if (attByCode) {
//       const dbFirst = attByCode.first_name.trim().toLowerCase();
//       const dbLast = attByCode.last_name.trim().toLowerCase();

//       const nameMatches = dbFirst === inputFirst && dbLast === inputLast;

//       if (!nameMatches) {
//         return res.status(400).json({
//           message: "Attendance ID already exists but belongs to another employee.",
//           att_db_name: `${attByCode.first_name} ${attByCode.last_name}`,
//           input_name: `${first_name} ${last_name}`,
//         });
//       }
//       // âœ” Same emp_code + same name â†’ ALLOW
//     }

//     // ============================================================
//     // 3ï¸âƒ£ HRMS DB CHECK â€” attendance_id duplicate?
//     // ============================================================
//     const hrmsRecord = await Employee.findOne({
//       where: { attendance_id: emp_code },
//     });

//     if (hrmsRecord) {
//       return res.status(400).json({
//         message: "Attendance ID already exists in HRMS database",
//         emp_code,
//       });
//     }

//     // ============================================================
//     // 4ï¸âƒ£ CREATE EMPLOYEE (All checks passed)
//     // ============================================================
//     const payload = {
//       first_name,
//       last_name,
//       emp_id,
//       attendance_id: emp_code,
//       ...otherFields,
//       profile_picture: req.file ? req.file.filename : null,
//       created_by: req.user?.id || "system",
//     };

//     const newEmployee = await employeeService.create(payload);

//     return res.status(201).json({
//       message: "Employee added successfully",
//       data: newEmployee,
//     });

//   } catch (error) {
//     console.error("âŒ Error in createEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to create employee",
//       error: error.message,
//     });
//   }
// };

// export const createEmployee = async (req, res) => {
//   try {
//     const { first_name, last_name, attendance_id, emp_id, ...otherFields } = req.body;

//     if (!first_name ) {
//       return res.status(400).json({
//         message: "First name and last name are required",
//       });
//     }

//     const emp_code = attendance_id;
//     if (!emp_code) {
//       return res.status(400).json({
//         message: "Attendance ID is required",
//       });
//     }

//     // Normalize input name
//     const inputFirst = first_name.trim().toLowerCase();
//     // const inputLast = last_name.trim().toLowerCase();

//     // ============================================================
//     // 1ï¸âƒ£ ATT DB â€” Find by emp_code
//     // ============================================================
//     const attByCode = await PersonnelEmployee.findOne({
//       where: { emp_code },
//     });

//     // ============================================================
//     // 2ï¸âƒ£ ATT DB â€” Find by name
//     // ============================================================
//     const attByName = await PersonnelEmployee.findOne({
//       where: {
//         first_name,
//         // last_name,
//       },
//     });

//     // ============================================================
//     // CASE A â€” emp_code NOT found
//     // ============================================================
//     if (!attByCode) {
//       if (attByName) {
//         return res.status(400).json({
//           message:
//             "Employee name already exists in ATT database with a different Attendance ID.",
//           existing_emp_code: attByName.emp_code,
//         });
//       }
//       // Allowed: new name + new code
//     }

//     // ============================================================
//     // CASE B â€” emp_code EXISTS â†’ check name
//     // ============================================================
//     if (attByCode) {
//       const dbFirst = (attByCode.first_name || "").trim().toLowerCase();
//       const dbLast = (attByCode.last_name || "").trim().toLowerCase();

//       const nameMatches = dbFirst === inputFirst && dbLast === inputLast;

//       if (!nameMatches) {
//         return res.status(400).json({
//           message: "Attendance ID already exists but belongs to another employee.",
//           att_db_name: `${attByCode.first_name || ""} ${attByCode.last_name || ""}`.trim(),
//           input_name: `${first_name} ${last_name}`,
//         });
//       }
//       // Allowed: same name + same code
//     }

//     // ============================================================
//     // 3ï¸âƒ£ HRMS DB CHECK
//     // ============================================================
//     const hrmsRecord = await Employee.findOne({
//       where: { attendance_id: emp_code },
//     });

//     if (hrmsRecord) {
//       return res.status(400).json({
//         message: "Attendance ID already exists in HRMS database",
//       });
//     }

//     // ============================================================
//     // 4ï¸âƒ£ CREATE EMPLOYEE
//     // ============================================================
//     const payload = {
//       first_name,
//       last_name,
//       emp_id,
//       attendance_id: emp_code,
//       ...otherFields,
//       profile_picture: req.file ? req.file.filename : null,
//       created_by: req.user?.id || "system",
//     };

//     const newEmployee = await employeeService.create(payload);

//     return res.status(201).json({
//       message: "Employee added successfully",
//       data: newEmployee,
//     });

//   } catch (error) {
//     console.error("âŒ Error in createEmployee:", error);
//     return res.status(500).json({
//       message: "Failed to create employee",
//       error: error.message,
//     });
//   }
// };

==========================================================================================================================================

// âœ… Registered Employees (Paginated + Search + Sorting)


// export const getRegisteredEmployees = async (req, res) => {
//   try {
//     const employees = await Employee.findAll({
//       where: { deleted_at: null },
//       include: [
//         {
//           model: EmployeeDetails,
//           as: "details",
//           required: true, // INNER JOIN (only registered)
//         },
//       ],
//     });

//     return res.status(200).json({
//       message: "Registered employees fetched successfully",
//       data: employees,
//     });
//   } catch (error) {
//     console.error("âŒ Error in getRegisteredEmployees:", error);
//     res.status(500).json({ message: "Server error", error: error.message });
//   }
// };

// // // âœ… 2. Unregistered Employees



// export const getUnregisteredEmployees = async (req, res) => {
//   try {
//     const employees = await Employee.findAll({
//       where: { deleted_at: null },
//       include: [
//         {
//           model: EmployeeDetails,
//           as: "details",
//           required: false, // LEFT JOIN
//         },
//       ],
//       // âœ… Filter employees who have no details
//       having: sequelize.literal(`details.id IS NULL`),
//       subQuery: false,
//     });

//     return res.status(200).json({
//       message: "Unregistered employees fetched successfully",
//       data: employees,
//     });
//   } catch (error) {
//     console.error("âŒ Error in getUnregisteredEmployees:", error);
//     res.status(500).json({ message: "Server error", error: error.message });
//   }
// };



// export const updateEmployeeFullInfo = async (req, res) => {
//   const transaction = await sequelize.transaction();

//   try {
//     const { employee_id } = req.params; // employee id from URL
//     if (!employee_id) {
//       return res.status(400).json({ message: "employee_id is required" });
//     }

//     const detailsData = req.body.details ? JSON.parse(req.body.details) : {};
//     const userId = req.user.id; // from token

//     // ðŸŸ¢ 1ï¸âƒ£ Handle EmployeeDetails
//     const existingDetails = await EmployeeDetails.findOne({ where: { employee_id }, transaction });

//     if (existingDetails) {
//       // Compare only if detailsData has keys
//       if (Object.keys(detailsData).length > 0) {
//         const hasChanges = Object.keys(detailsData).some(
//           (key) => detailsData[key] != existingDetails[key]
//         );

//         if (hasChanges) {
//           await existingDetails.update(
//             { ...detailsData, updated_by: userId },
//             { transaction }
//           );
//           console.log("ðŸŸ¢ Employee details updated.");
//         } else {
//           console.log("â© No changes in employee details, keeping old data.");
//         }
//       } else {
//         console.log("â© No new details sent, keeping old data.");
//       }
//     } else {
//       // If details didnâ€™t exist, create a new one
//       await EmployeeDetails.create(
//         { ...detailsData, employee_id, created_by: userId, updated_by: userId },
//         { transaction }
//       );
//       console.log("ðŸŸ¢ Employee details created (no existing record).");
//     }

//     // ðŸŸ¢ 2ï¸âƒ£ Handle EmployeeDocuments
//     const docFields = [
//       "resume", "aadhar", "pan", "degree", "marksheet", "relieving",
//       "experience", "offer", "passport", "driving", "addressproof", "bankproof"
//     ];

//     const uploadedDocs = {};
//     docFields.forEach((field) => {
//       if (req.files && req.files[field]) {
//         uploadedDocs[field] = path.basename(req.files[field][0].path);
//       }
//     });

//     const existingDocs = await EmployeeDocuments.findOne({ where: { employee_id }, transaction });

//     if (existingDocs) {
//       if (Object.keys(uploadedDocs).length > 0) {
//         const hasDocChanges = Object.keys(uploadedDocs).some(
//           (key) => uploadedDocs[key] != existingDocs[key]
//         );

//         if (hasDocChanges) {
//           await existingDocs.update(
//             { ...uploadedDocs, updated_by: userId },
//             { transaction }
//           );
//           console.log("ðŸŸ¢ Employee documents updated.");
//         } else {
//           console.log("â© No new document changes, keeping old files.");
//         }
//       } else {
//         console.log("â© No document uploads provided, keeping old files.");
//       }
//     } else {
//       await EmployeeDocuments.create(
//         { employee_id, ...uploadedDocs, created_by: userId, updated_by: userId },
//         { transaction }
//       );
//       console.log("ðŸŸ¢ Employee documents created (no existing record).");
//     }

//     // ðŸŸ¢ 3ï¸âƒ£ EmployeeEmergency Contacts (update without duplication)
// if (req.body.emergency) {
//   let emergencyData = [];
//   try {
//     if (req.body.emergency.trim() !== "") {
//       emergencyData = JSON.parse(req.body.emergency);
//     }
//   } catch (err) {
//     console.warn("âš ï¸ Invalid emergency JSON:", err.message);
//   }

//   const existingContacts = await EmployeeEmergency.findAll({ where: { employee_id }, transaction });

//   // Update or create contacts
//   const updatedOrCreatedIds = [];

//   for (const contact of emergencyData) {
//     if (contact.id) {
//       // Check if the contact already exists
//       const existing = existingContacts.find((c) => c.id === contact.id);
//       if (existing) {
//         // Update only if there are actual changes
//         const hasChanges = Object.keys(contact).some(
//           (key) => contact[key] != existing[key]
//         );

//         if (hasChanges) {
//           await existing.update(
//             { ...contact, updated_by: userId },
//             { transaction }
//           );
//           console.log(`ðŸŸ¢ Updated emergency contact ${contact.id}`);
//         } else {
//           console.log(`â© No changes for contact ${contact.id}`);
//         }

//         updatedOrCreatedIds.push(contact.id);
//       } else {
//         // If ID provided but not found, create new
//         const newContact = await EmployeeEmergency.create(
//           { ...contact, employee_id, created_by: userId, updated_by: userId },
//           { transaction }
//         );
//         updatedOrCreatedIds.push(newContact.id);
//         console.log(`ðŸŸ¢ Created new contact (id mismatch): ${newContact.id}`);
//       }
//     } else {
//       // No ID means new contact
//       const newContact = await EmployeeEmergency.create(
//         { ...contact, employee_id, created_by: userId, updated_by: userId },
//         { transaction }
//       );
//       updatedOrCreatedIds.push(newContact.id);
//       console.log("ðŸŸ¢ Created new emergency contact");
//     }
//   }

//   // Delete contacts not included in the new request
//   const toDelete = existingContacts.filter(
//     (c) => !updatedOrCreatedIds.includes(c.id)
//   );
//   for (const del of toDelete) {
//     await del.destroy({ transaction });
//     console.log(`ðŸ—‘ï¸ Deleted old emergency contact: ${del.id}`);
//   }

// } else {
//   console.log("â© Skipping emergency contact update since none was provided.");
// }

//     await transaction.commit();

//     return res.status(200).json({
//       message: "Employee full info updated successfully",
//     });
//   } catch (error) {
//     await transaction.rollback();
//     console.error("âŒ Error updating employee info:", error);
//     return res.status(500).json({
//       message: "Error updating employee information",
//       error: error.message,
//     });
//   }
// };


// export const addEmployeeFullInfo = async (req, res) => {
//   const transaction = await sequelize.transaction();

//   try {
//     const { employee_id } = req.body;
//     if (!employee_id) {
//       return res.status(400).json({ message: "employee_id is required" });
//     }

//     const detailsData = req.body.details ? JSON.parse(req.body.details) : {};
//     const emergencyData = req.body.emergency ? JSON.parse(req.body.emergency) : [];

//     const userId = req.user.id; // <-- from token

//     // Employee Details
//     const employeeDetails = await EmployeeDetails.create(
//       { ...detailsData, employee_id, created_by: userId, updated_by: userId },
//       { transaction }
//     );
// const personalDetId = employeeDetails.id; // <-- IMPORTANT
//     // Employee Documents
//     const docFields = [
//       "resume","aadhar","pan","degree","marksheet","relieving","experience",
//       "offer","passport","driving","addressproof","bankproof"
//     ];

//     const uploadedDocs = {};
//     docFields.forEach((field) => {
//       if (req.files && req.files[field]) {
//         uploadedDocs[field] = path.basename(req.files[field][0].path);
//       }
//     });

//     const employeeDocuments = await EmployeeDocuments.create(
//       { employee_id, personalDetId, ...uploadedDocs, created_by: userId, updated_by: userId },
//       { transaction }
//     );

//     // Employee Emergency Contacts
//     const employeeEmergencies = await Promise.all(
//       emergencyData.map((contact) =>
//         EmployeeEmergency.create({ ...contact, employee_id, personalDetId, created_by: userId, updated_by: userId }, { transaction })
//       )
//     );

//     await transaction.commit();

//     return res.status(201).json({
//       message: "Employee full info added successfully",
//       data: { details: employeeDetails, documents: employeeDocuments, emergencies: employeeEmergencies },
//     });
//   } catch (error) {
//     await transaction.rollback();
//     console.error("âŒ Error adding employee info:", error);
//     return res.status(500).json({
//       message: "Error adding employee information",
//       error: error.message,
//     });
//   }
// };

